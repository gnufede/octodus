{% from "macros/_misc.html" import render_input, render_action %}

{% set page_title = _('Escoge Oferta') %}

{% extends 'user_index.html' %}

{% block append_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/jquery-ui-1.8.16.custom.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/jquery-ui-1.8.16.ie.css') }}">
<style type='text/css'>
    .labeled.focused
    {
        background-color: #EEEEEE;
        font-style: italic;
    }
</style>
{% endblock %}

{% block append_js %}
<script src="{{ url_for('static', filename='js/libs/jquery-ui-1.8.16.custom.min.js') }}"></script>
<script type='text/javascript'>

    function updateSelectedStyle() {
        $(':radio').removeClass('focused').next().removeClass('focused');
        $(':radio:checked').addClass('focused').next().addClass('focused');
    }
    
    function findByField(a, field, value) {
        for (var i = 0; i < a.length; i++) {
            var obj = a[i];
            if (obj[field] == value) return i;
        }
        return -1;
    }

    $("label").css({'display': 'inline'});
    $('#select_offer').addClass('active');
    
    var base_url = '/admin/offers';
    var type = 1;
    var currentData;
    var selection = [];
    var fullSelection = [];
    
    $(function() {
        
        $('#submit').attr('id', 'submit_').attr('name', 'submit_'); // Fix for a flask.wtf and/or jQuery bug: http://bugs.jquery.com/ticket/4652
    
	    $('#confirm').dialog({
	        autoOpen: false,
		    resizable: false,
		    height: 250,
		    modal: true,
		    buttons: {
			    Confirmar: function() {
				    $('#confirm').dialog('close');
				    $('#user_choice').submit();
			    },
			    Cancelar: function() {
				    $('#confirm').dialog('close');
				    return false;
			    }
		    }
	    });
    
        $(':radio').live('click', function() {
            var id = $(this).val();
            retrieveByID(id);
        });
    
        $('#submit_').click(function() {
            var id = $(':radio:checked').val();
            if (id || type==2) {
                if (id) {
                    var found = findByField(selection, 'id', id);
                    if (found == -1) {
                        selection.push({id: id, price: currentData[id].price, name: currentData[id].name});
                    }
                }
                type++;
                retrieveByType(type);
            } else {
                alert('No se ha seleccionado ninguna opción');
            }
            return false; // Avoid submit
        });
        
        retrieveByType(type);
        
    });
    
    function retrieveByID(id) {
        retrieve(id, false);
    }
    
    function retrieveByType(type) {
        retrieve(type, true);
    }
    
    function retrieve(num, byType) {
        
        var url = base_url;
        var id = String(num);
        var showPrice = byType;
        
        if (byType) {
            url += '/type';
        }
        
        url += '/' + id;
        
        $('label').removeClass('focused');
        $('label[for="' + id + '"]').addClass('focused')
        
        $.getJSON(url, function(data) {
        
            if ($.isEmptyObject(data)) {
            
                if (byType) {
                    $('#selection').empty().append('<br />');
                    $('#type').empty();
                    
                    var total = 0.0;
                    
                    $.each(selection, function(key, val) {
                        $('#selection').append(val.name + ': ' + val.price + '€<br />');
                        total += val.price;
                        $('#type').append(val.id + ',');
                    });
                    
                    var totalF = parseFloat(total).toFixed(2);
                    var totalIVA = parseFloat(total * 1.21).toFixed(2);
                    
                    $('#selection').append('TOTAL SIN IVA: ' + totalF + '€<br />TOTAL CON IVA: ' + totalIVA + '€<br />');
                    
                    $('#confirm').dialog('open');
                }
                
                return;
            }
            
            currentData = data;
        
            $('.input').empty().append('<div class="thumbnails"><ul></ul></div>');
    
            var lst = $('.thumbnails ul');
            
            $.each(data, function(key, val) {
                    html = '<li class="input" style="display:inline-block; padding-right:20px; padding-bottom:20px;"><input class="clickable" type="radio" name="options" style="display:none" id="' + key + '" value=' + key + '>' +
                    '<label class="labeled" for="' + key + '" style="display:inline-block; max-width:190px"><div class="thumbnail"><img style="width:190px" src=' + val.img + '> <div class="name"><h3>' + val.name + '</h3> </div>' 
                    if (showPrice) {
                        html = html + 
                        '<div class="price"><b>' + val.price + ' € (IVA no incluido)</b></div>'
                    }
                   html = html + 
                   '<hr style="margin:10px 0;"/><div class="description" style="margin-bottom:10px;"> ' + val.description + '</div></div></label></li>'
                    lst.append(html);
            });
            
        });
        
    }
    
</script>
{% endblock %}

{% block body %}


<div class='span9'>
    <!--<form class='form-stacked' method="POST" action="{{ url_for('user.set_offer', type_id=form.type.data) }}">-->
    <form id="user_choice" class='form-stacked' method="POST" action="{{ url_for('user.save_user_choice') }}">
        {{ form.hidden_tag() }}
        {{ form.next }}
        
        <div class="input">
        </div>

        {{ render_action(form.submit) }}
        
    </form>
</div>

<div id="confirm" title="Confirmar selección">
	<p>
	    <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>
	    Su selección es:
	    <span id="selection"></span>
	    ¿confirma que desea continuar?
	</p>
</div>

{% endblock %}
